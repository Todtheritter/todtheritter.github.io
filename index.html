<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>North Carolina Legislative Votes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- Turf -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100%; }
  </style>
</head>

<body>

<div id="map"></div>

<!-- Leaflet JS MUST come before your script -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Your map script -->
<script>
const map = L.map('map', {
  center: [35.5, -79],
  zoom: 7,
  minZoom: 6,
  maxZoom: 12,
  maxBounds: [
    [33.5, -85],
    [37, -75]
  ]
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

Promise.all([
  fetch('nc-house.geojson').then(r => r.json()),
  fetch('nc-house-reps-voteResultsfull.json').then(r => r.json()),
  fetch('nc-senate-boundary.json').then(r => r.json()),
  fetch('nc-senate-reps-voteResultsfull.json').then(r => r.json())
]).then(([houseGeo, houseVotes, senateGeo, senateVotes]) => {

  let activeLayer;
  let activeVoteData;

  function createLayer(geoData, voteData) {

    function style(feature) {
      const district = feature.properties.DISTRICT;
      const info = voteData[district];

      if (info && info.vote === "Yes") {
        return {
          color: "#444",
          weight: 1,
          fillColor: "#f1c40f",
          fillOpacity: 0.5
        };
      }

      return {
        color: "#444",
        weight: 1,
        fillColor: "transparent",
        fillOpacity: 0
      };
    }

    function highlightFeature(e) {
      e.target.setStyle({
        weight: 2,
        color: "#000"
      });
    }

    function resetHighlight(e) {
      layerGroup.resetStyle(e.target);
    }

    function onEachFeature(feature, layer) {
      const district = feature.properties.DISTRICT;
      const info = voteData[district];

      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight
      });

      if (info) {
        layer.bindPopup(`
          <strong>District ${district}</strong><br>
          Representative: ${info.rep}<br>
          Party: ${info.party}<br>
          Tenure: ${info.tenure}<br>
          Vote: ${info.vote || "No data"}
        `);
      }
    }

    const layerGroup = L.geoJSON(geoData, {
      style: style,
      onEachFeature: onEachFeature
    });

    return layerGroup;
  }

  const houseLayer = createLayer(houseGeo, houseVotes);
  const senateLayer = createLayer(senateGeo, senateVotes);

  // Start with House
  houseLayer.addTo(map);
  activeLayer = houseLayer;
  activeVoteData = houseVotes;

  // Toggle control
  const toggleControl = L.control({ position: "topright" });

  toggleControl.onAdd = function () {
    const div = L.DomUtil.create("div");
    div.innerHTML = `
      <div style="
        background:white;
        padding:8px;
        box-shadow:0 0 6px rgba(0,0,0,0.3);
        border-radius:6px;
      ">
        <button onclick="switchLayer('house')" style="margin-right:4px;">House</button>
        <button onclick="switchLayer('senate')">Senate</button>
      </div>
    `;
    return div;
  };

  toggleControl.addTo(map);

  window.switchLayer = function(type) {
    map.removeLayer(activeLayer);

    if (type === "house") {
      activeLayer = houseLayer;
      activeVoteData = houseVotes;
    } else {
      activeLayer = senateLayer;
      activeVoteData = senateVotes;
    }

    activeLayer.addTo(map);
  };

  // Address Search (works with active layer)
  window.searchAddress = async function () {
    const address = document.getElementById("addressInput").value;
    if (!address) return;

    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`
      );

      const results = await response.json();
      if (!results.length) {
        alert("Address not found.");
        return;
      }

      const lat = parseFloat(results[0].lat);
      const lon = parseFloat(results[0].lon);
      const point = turf.point([lon, lat]);

      let foundDistrict = null;

      activeLayer.eachLayer(layer => {
        const polygon = layer.toGeoJSON();
        if (turf.booleanPointInPolygon(point, polygon)) {
          foundDistrict = layer;
        }
      });

      if (foundDistrict) {
        map.setView([lat, lon], 10);
        foundDistrict.openPopup();
      } else {
        alert("No district found for that address.");
      }

    } catch (error) {
      console.error(error);
      alert("Search error occurred.");
    }
  };

  // Legend (static text – can be upgraded to dynamic if desired)
  const legend = L.control({ position: "bottomright" });

  legend.onAdd = function () {
    const div = L.DomUtil.create("div");
    div.innerHTML = `
      <div style="
        background:white;
        padding:10px;
        font-size:13px;
        line-height:1.4;
        box-shadow:0 0 6px rgba(0,0,0,0.3);
        border-radius:6px;
        max-width:260px;
      ">
        <div style="display:flex;align-items:center;margin-bottom:6px;">
          <span style="
            width:18px;
            height:18px;
            background:#f1c40f;
            opacity:0.5;
            display:inline-block;
            margin-right:8px;
          "></span>
          Voted YES
        </div>
        <div style="font-size:12px;">
          This bill removed the 2030 carbon reduction target and changed regulatory rules on cost recovery (including construction and fuel costs), expanding Duke Energy’s ability to include certain costs in rates. Passed over the governor’s veto.
        </div>
      </div>
    `;
    return div;
  };

  legend.addTo(map);

})
.catch(error => {
  console.error("Error loading data:", error);
});

</script>

</body>
</html>











