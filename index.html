<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>North Carolina Legislative Votes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100%; }

    #searchBox {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.25);
      display: flex;
      gap: 6px;
    }

    #searchBox input {
      width: 260px;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #searchBox button {
      padding: 6px 10px;
      cursor: pointer;
      border: none;
      background: #2c7fb8;
      color: white;
      border-radius: 4px;
    }
  </style>
</head>

<body>

<div id="searchBox">
  <input type="text" id="addressInput" placeholder="Enter address in North Carolina..." />
  <button onclick="searchAddress()">Search</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

const map = L.map('map', {
  center: [35.5, -79],
  zoom: 7,
  minZoom: 6,
  maxZoom: 12,
  maxBounds: [
    [33.5, -85],
    [37, -75]
  ]
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

Promise.all([
  fetch('nc-house.geojson').then(r => r.json()),
  fetch('nc-house-reps-voteResultsfull.json').then(r => r.json()),
  fetch('nc-senate.json.json').then(r => r.json()),
  fetch('nc-senate-reps-voteResultsfull.json').then(r => r.json())
]).then(([houseGeo, houseVotes, senateGeo, senateVotes]) => {

  let colorMode = "vote";
  let activeLayer;

  function createLayer(geoData, voteData) {

    function style(feature) {
      const district = feature.properties.DISTRICT;
      const info = voteData[district];

      if (!info) {
        return { color:"#444", weight:1, fillOpacity:0 };
      }

      let fillColor = "#999";

      if (colorMode === "vote") {
        if (info.vote === "Yes") fillColor = "#f1c40f";
        else if (info.vote === "No") fillColor = "#8e44ad";
        else fillColor = "#999999";
      }

      if (colorMode === "party") {
        if (info.vote === "Yes" && info.party === "Republican")
          fillColor = "#c0392b";
        else if (info.vote === "Yes" && info.party === "Democrat")
          fillColor = "#2980b9";
        else if (info.vote === "No")
          fillColor = "#8e44ad";
        else
          fillColor = "#999999";
      }

      return {
        color: "#444",
        weight: 1,
        fillColor: fillColor,
        fillOpacity: 0.5
      };
    }

    const layer = L.geoJSON(geoData, {
      style: style,
      onEachFeature: function(feature, layer) {
        const district = feature.properties.DISTRICT;
        const info = voteData[district];

        if (info) {
          layer.bindPopup(`
            <strong>District ${district}</strong><br>
            Representative: ${info.rep}<br>
            Party: ${info.party}<br>
            Tenure: ${info.tenure}<br>
            Vote: ${info.vote || "No data"}
          `);
        }
      }
    });

    layer._styleFunction = style;
    return layer;
  }

  const houseLayer = createLayer(houseGeo, houseVotes);
  const senateLayer = createLayer(senateGeo, senateVotes);

  houseLayer.addTo(map);
  activeLayer = houseLayer;

  // House/Senate Toggle
  const chamberControl = L.control({ position: "topright" });
  chamberControl.onAdd = function () {
    const div = L.DomUtil.create("div");
    div.style.background = "white";
    div.style.padding = "8px";
    div.style.boxShadow = "0 0 6px rgba(0,0,0,0.3)";
    div.style.borderRadius = "6px";

    const houseBtn = L.DomUtil.create("button", "", div);
    houseBtn.innerHTML = "House";
    houseBtn.style.marginRight = "4px";

    const senateBtn = L.DomUtil.create("button", "", div);
    senateBtn.innerHTML = "Senate";

    houseBtn.onclick = () => {
      map.removeLayer(activeLayer);
      activeLayer = houseLayer;
      activeLayer.addTo(map);
    };

    senateBtn.onclick = () => {
      map.removeLayer(activeLayer);
      activeLayer = senateLayer;
      activeLayer.addTo(map);
    };

    return div;
  };
  chamberControl.addTo(map);

  // Vote/Party Toggle
  const colorControl = L.control({ position: "topright" });
  colorControl.onAdd = function () {
    const div = L.DomUtil.create("div");
    div.style.background = "white";
    div.style.padding = "8px";
    div.style.marginTop = "8px";
    div.style.boxShadow = "0 0 6px rgba(0,0,0,0.3)";
    div.style.borderRadius = "6px";

    const voteBtn = L.DomUtil.create("button", "", div);
    voteBtn.innerHTML = "Vote View";
    voteBtn.style.marginRight = "4px";

    const partyBtn = L.DomUtil.create("button", "", div);
    partyBtn.innerHTML = "Party View";

    voteBtn.onclick = () => {
      colorMode = "vote";
      activeLayer.setStyle(activeLayer._styleFunction);
    };

    partyBtn.onclick = () => {
      colorMode = "party";
      activeLayer.setStyle(activeLayer._styleFunction);
    };

    return div;
  };
  colorControl.addTo(map);

  // Address Search
  window.searchAddress = async function () {
    const address = document.getElementById("addressInput").value;
    if (!address) return;

    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`
    );

    const results = await response.json();
    if (!results.length) return alert("Address not found.");

    const lat = parseFloat(results[0].lat);
    const lon = parseFloat(results[0].lon);
    const point = turf.point([lon, lat]);

    let found = null;

    activeLayer.eachLayer(layer => {
      if (turf.booleanPointInPolygon(point, layer.toGeoJSON())) {
        found = layer;
      }
    });

    if (found) {
      map.setView([lat, lon], 10);
      found.openPopup();
    } else {
      alert("No district found for that address.");
    }
  };

});
</script>

</body>
</html>










