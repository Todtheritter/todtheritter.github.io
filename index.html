<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>North Carolina Legislative Votes</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100%; }

    #searchBox {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.25);
      display: flex;
      gap: 6px;
    }

    #searchBox input {
      width: 260px;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #searchBox button {
      padding: 6px 10px;
      cursor: pointer;
      border: none;
      background: #2c7fb8;
      color: white;
      border-radius: 4px;
    }

    #searchBox button:hover {
      background: #1d5f8a;
    }
  </style>
</head>

<body>

<div id="searchBox">
  <input type="text" id="addressInput" placeholder="Enter address in North Carolina..." />
  <button onclick="searchAddress()">Search</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

const map = L.map('map', {
  center: [35.5, -79],
  zoom: 7,
  minZoom: 6,
  maxZoom: 12,
  maxBounds: [
    [33.5, -85],
    [37, -75]
  ]
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

Promise.all([
  fetch('nc-house.geojson').then(r => r.json()),
  fetch('nc-house-reps-voteResultsfull.json').then(r => r.json())
]).then(([districtGeo, voteResults]) => {

  let geojson;

  function style(feature) {
    const district = feature.properties.DISTRICT;
    const info = voteResults[district];

    if (info && info.vote === "Yes") {
      return {
        color: "#444",
        weight: 1,
        fillColor: "#2ca25f",
        fillOpacity: 0.5
      };
    }

    return {
      color: "#444",
      weight: 1,
      fillColor: "transparent",
      fillOpacity: 0
    };
  }

  function highlightFeature(e) {
    e.target.setStyle({
      weight: 2,
      color: "#000"
    });
  }

  function resetHighlight(e) {
    geojson.resetStyle(e.target);
  }

  function onEachFeature(feature, layer) {
    const district = feature.properties.DISTRICT;
    const info = voteResults[district];

    layer.on({
      mouseover: highlightFeature,
      mouseout: resetHighlight
    });

    if (info) {
      layer.bindPopup(`
        <strong>District ${district}</strong><br>
        Representative: ${info.rep}<br>
        Party: ${info.party}<br>
        Tenure: ${info.tenure}<br>
        Vote: ${info.vote || "No data"}
      `);
    }
  }

  geojson = L.geoJSON(districtGeo, {
    style: style,
    onEachFeature: onEachFeature
  }).addTo(map);

  // Address Search
  window.searchAddress = async function () {
    const address = document.getElementById("addressInput").value;
    if (!address) return;

    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`
      );

      const results = await response.json();
      if (!results.length) {
        alert("Address not found.");
        return;
      }

      const lat = parseFloat(results[0].lat);
      const lon = parseFloat(results[0].lon);

      const point = turf.point([lon, lat]);

      let foundDistrict = null;

      geojson.eachLayer(layer => {
        const polygon = layer.toGeoJSON();
        if (turf.booleanPointInPolygon(point, polygon)) {
          foundDistrict = layer;
        }
      });

      if (foundDistrict) {
        map.setView([lat, lon], 10);
        foundDistrict.openPopup();
      } else {
        alert("No district found for that address.");
      }

    } catch (error) {
      console.error(error);
      alert("Search error occurred.");
    }
  };

  // Legend
  const legend = L.control({ position: "bottomright" });

  legend.onAdd = function () {
    const div = L.DomUtil.create("div");

    div.innerHTML = `
      <div style="
        background:white;
        padding:10px;
        font-size:13px;
        line-height:1.4;
        box-shadow:0 0 6px rgba(0,0,0,0.3);
        border-radius:6px;
        max-width:260px;
      ">
        <div style="display:flex;align-items:center;margin-bottom:6px;">
          <span style="
            width:18px;
            height:18px;
            background:#2ca25f;
            opacity:0.5;
            display:inline-block;
            margin-right:8px;
          "></span>
          Voted YES
        </div>
        <div style="font-size:12px;">
          Bill removed the 2030 carbon reduction target and changed regulatory rules on cost recovery (including construction and fuel costs), expanding Duke Energy’s ability to include certain costs in rates. Passed over the governor’s veto.
        </div>
      </div>
    `;

    return div;
  };

  legend.addTo(map);

})
.catch(error => {
  console.error("Error loading data:", error);
});

</script>

</body>
</html>




